name: Deploy to GitHub Pages

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v3

      - name: Install pnpm ğŸ“¦
        uses: pnpm/action-setup@v2
        with:
          version: 8
          run_install: false

      - name: Setup Node.js âš™ï¸
        uses: actions/setup-node@v3
        with:
          node-version: 18
          cache: "pnpm"

      - name: Install dependencies ğŸ“¦
        run: pnpm install

      - name: Download images ğŸ–¼ï¸
        run: node scripts/download-images.js

      - name: Build ğŸ—ï¸
        run: |
          echo "å¼€å§‹æ„å»º..."
          echo "GITHUB_ACTIONS=${GITHUB_ACTIONS}"
          echo "GITHUB_REPOSITORY=${GITHUB_REPOSITORY}"
          # æ˜¾ç¤ºnext.config.tså†…å®¹
          echo "next.config.tså†…å®¹:"
          cat next.config.ts
          # æ‰§è¡Œæ„å»º
          pnpm run build
          # æ£€æŸ¥æ„å»ºç»“æœ
          echo "æ„å»ºå®Œæˆï¼Œæ£€æŸ¥outç›®å½•æ˜¯å¦å­˜åœ¨:"
          if [ -d "out" ]; then
            echo "outç›®å½•å­˜åœ¨"
            echo "outç›®å½•å†…å®¹:"
            ls -la out/
          else
            echo "outç›®å½•ä¸å­˜åœ¨!"
            echo "å½“å‰ç›®å½•å†…å®¹:"
            ls -la
          fi
        env:
          # è®¾ç½®ç¯å¢ƒå˜é‡ï¼Œè®©Next.jsçŸ¥é“è¿™æ˜¯GitHub Pagesç¯å¢ƒ
          GITHUB_ACTIONS: "true"
          GITHUB_REPOSITORY: ${{ github.repository }}

      - name: Check export directory ğŸ”
        run: node scripts/check-export.js

      - name: Debug info before deployment ğŸ”
        run: |
          echo "ä»“åº“ä¿¡æ¯:"
          echo "Repository: ${{ github.repository }}"
          echo "Branch: ${{ github.ref }}"
          echo "è¾“å‡ºç›®å½•å†…å®¹:"
          ls -la out/
          echo "æ£€æŸ¥index.htmlæ–‡ä»¶:"
          if [ -f out/index.html ]; then
            echo "index.html å­˜åœ¨"
            head -n 20 out/index.html
          else
            echo "index.html ä¸å­˜åœ¨!"
          fi
          echo "æ£€æŸ¥404.htmlæ–‡ä»¶:"
          if [ -f out/404.html ]; then
            echo "404.html å­˜åœ¨"
          else
            echo "404.html ä¸å­˜åœ¨!"
          fi

      - name: Add .nojekyll file ğŸ“„
        run: |
          touch out/.nojekyll
          # ç¡®ä¿æ²¡æœ‰README.mdæ–‡ä»¶åœ¨outç›®å½•ä¸­
          if [ -f out/README.md ]; then
            rm out/README.md
            echo "å·²åˆ é™¤ out/README.md æ–‡ä»¶"
          fi
          # åˆ›å»ºä¸€ä¸ªç®€å•çš„æµ‹è¯•æ–‡ä»¶
          echo "<html><body><h1>æµ‹è¯•é¡µé¢</h1><p>å¦‚æœæ‚¨çœ‹åˆ°æ­¤é¡µé¢ï¼Œè¯´æ˜éƒ¨ç½²æˆåŠŸ!</p></body></html>" > out/test.html
          echo "å·²åˆ›å»ºæµ‹è¯•æ–‡ä»¶ test.html"
          
          # å¤‡ä»½åŸå§‹index.html (å¦‚æœå­˜åœ¨)
          if [ -f out/index.html ]; then
            cp out/index.html out/index.original.html
            echo "å·²å¤‡ä»½åŸå§‹index.html"
            # æ£€æŸ¥index.htmlå†…å®¹
            echo "åŸå§‹index.htmlå†…å®¹å‰50è¡Œ:"
            head -n 50 out/index.html
          fi
          
          # åˆ›å»ºä¸€ä¸ªç®€å•çš„index.htmlæµ‹è¯•æ–‡ä»¶
          echo '<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å’–å•¡åº—ç½‘ç«™ - æµ‹è¯•é¡µé¢</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; line-height: 1.6; }
        .container { max-width: 800px; margin: 0 auto; padding: 20px; }
        h1 { color: #5D4037; }
        .links { margin-top: 20px; }
        .links a { display: block; margin-bottom: 10px; color: #795548; }
    </style>
</head>
<body>
    <div class="container">
        <h1>å’–å•¡åº—ç½‘ç«™ - æµ‹è¯•é¡µé¢</h1>
        <p>å¦‚æœæ‚¨çœ‹åˆ°æ­¤é¡µé¢ï¼Œè¯´æ˜GitHub Pageséƒ¨ç½²æˆåŠŸ!</p>
        <p>è¿™æ˜¯ä¸€ä¸ªä¸´æ—¶æµ‹è¯•é¡µé¢ï¼Œç”¨äºéªŒè¯GitHub Pageséƒ¨ç½²æ˜¯å¦æ­£å¸¸å·¥ä½œã€‚</p>
        
        <div class="links">
            <h2>æµ‹è¯•é“¾æ¥:</h2>
            <a href="test.html">æµ‹è¯•é¡µé¢</a>
            <a href="index.original.html">åŸå§‹Next.jsç”Ÿæˆçš„é¡µé¢</a>
        </div>
        
        <p>éƒ¨ç½²æ—¶é—´: ' $(date) '</p>
        <p>ä»“åº“: ${{ github.repository }}</p>
    </div>
</body>
</html>' > out/index.html
          echo "å·²åˆ›å»ºç®€å•çš„index.htmlæµ‹è¯•æ–‡ä»¶"

      - name: Deploy to GitHub Pages ğŸš€
        uses: JamesIves/github-pages-deploy-action@v4
        id: deployment
        with:
          folder: out
          branch: gh-pages
          clean: true # æ¸…é™¤ç›®æ ‡åˆ†æ”¯ä¸Šçš„æ—§æ–‡ä»¶

      - name: Check gh-pages branch after deployment ğŸ”
        if: success()
        run: |
          echo "éƒ¨ç½²å®Œæˆï¼Œæ£€æŸ¥gh-pagesåˆ†æ”¯å†…å®¹"
          git clone --depth 1 --branch gh-pages https://github.com/${{ github.repository }}.git gh-pages-check
          echo "gh-pagesåˆ†æ”¯å†…å®¹:"
          ls -la gh-pages-check/
          echo "æ£€æŸ¥index.htmlæ–‡ä»¶:"
          if [ -f gh-pages-check/index.html ]; then
            echo "index.html å­˜åœ¨äºgh-pagesåˆ†æ”¯"
            head -n 20 gh-pages-check/index.html
          else
            echo "index.html ä¸å­˜åœ¨äºgh-pagesåˆ†æ”¯!"
          fi
          echo "æ£€æŸ¥.nojekyllæ–‡ä»¶:"
          if [ -f gh-pages-check/.nojekyll ]; then
            echo ".nojekyll å­˜åœ¨äºgh-pagesåˆ†æ”¯"
          else
            echo ".nojekyll ä¸å­˜åœ¨äºgh-pagesåˆ†æ”¯!"
          fi
          echo "æ£€æŸ¥test.htmlæ–‡ä»¶:"
          if [ -f gh-pages-check/test.html ]; then
            echo "test.html å­˜åœ¨äºgh-pagesåˆ†æ”¯"
          else
            echo "test.html ä¸å­˜åœ¨äºgh-pagesåˆ†æ”¯!"
          fi

      - name: Output deployment URL ğŸŒ
        run: |
          echo "ç½‘ç«™å·²éƒ¨ç½²åˆ°: https://$(echo '${{ github.repository_owner }}' | tr '[:upper:]' '[:lower:]').github.io/$(echo '${{ github.repository }}' | cut -d'/' -f2)/"
          echo "æµ‹è¯•é¡µé¢: https://$(echo '${{ github.repository_owner }}' | tr '[:upper:]' '[:lower:]').github.io/$(echo '${{ github.repository }}' | cut -d'/' -f2)/test.html"
